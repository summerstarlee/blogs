# 小程序的启动流程及优化

## 启动过程

### 第一步、环境准备

1. 小程序运行进程及运行环境的准备
2. 代码包下载、校验及初始化
3. 视图层系统组件、WebView 容器和原生组件的初始化
4. 逻辑层JS引擎初始化及域的创建

### 第二步、代码注入

#### 框架及第三方基础代码的初始化

1. 小程序基础库的注入
2. 扩展库，例如通过 useExtendedLib 引入的 WeUI 以及 kbone 的类库的初始化
3. 插件、自定义组件扩展库代码的注入

#### 开发者代码的注入

1. 开发者逻辑层代码的注入， 这时会派发小程序的 App.onLaunch 和 App.onShow 事件的派发。
2. 开发者视图层代码的注入， 包括公共代码以及页面代码的注入。

### 第三步、首屏渲染

1. 页面的初始化， 这个时间点是 initDataSendTime 的触发时机， 会派发 Page.onLoad 事件
2. 进入到 viewLayerPeaderStartTime 阶段， 会派发 Page.onShow 事件
3. 开发者代码中从后端拉取数据准备 data 数据
4. 页面整体渲染
5. 进入到 viewPlayerReaderEndTimer 阶段, 触发 Page.onReady 事件， 标志着首屏渲染完成。

## 启动方式

### 冷启动 vs 热启动

小程序在用户设备上是第一次打开的，或者是在销毁后再次打开的，就是冷启动过程。 小程序进入后台30分钟内再次进入到前台，可以直接从后台状态恢复到前台，这种方式是热启动。

## 启动过程的生命周期

1. App.onLaunch  page.onLoad page.onReady 是启动过程中的一次性事件
2. App.onShow Page.onShow 是启动过程中的重复性事件

## 启动流程中的优化节点

### 环境准备阶段， 拉取小程序基本信息阶段

### 紧跟小程序基础库更新

### 代码注入阶段

### 合适的生命周期函数节点

### Page.onReady 事件派发、首屏渲染完成阶段

### 数据预拉取和周期性更新机制

### 低端机首次渲染需要较长时间的情况

## 打开率/到达率

首页渲染次数与小程序启动次数的比值（PV）。 `Page.onReady 次数 / App.onLaunch 次数`

## 流失率

`1 - 到达率`

## 重点总结

1. 小程序的【首页渲染完成】的标识是 `Page.onReady` 事件触发。
